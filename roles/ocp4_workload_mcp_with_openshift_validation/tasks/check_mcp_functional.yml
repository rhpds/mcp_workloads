---
# ==============================================================================
# Functional Test: MCP Server Integration for Single User
# ==============================================================================

- name: Get LibreChat credentials for {{ _user }}
  ansible.builtin.set_fact:
    _librechat_url: "{{ lookup('rhpds.mcp_workloads.agnosticd_user_data', 'librechat_url') | default('') }}"
    _librechat_user: "{{ lookup('rhpds.mcp_workloads.agnosticd_user_data', 'librechat_user_' ~ _user) | default('') }}"
    _librechat_password: "{{ lookup('rhpds.mcp_workloads.agnosticd_user_data', 'librechat_password_' ~ _user) | default('') }}"
    _openshift_mcp_url: "{{ lookup('rhpds.mcp_workloads.agnosticd_user_data', 'openshift_mcp_server_url_' ~ _user) | default('') }}"
    _gitea_mcp_url: "{{ lookup('rhpds.mcp_workloads.agnosticd_user_data', 'gitea_mcp_server_url_' ~ _user) | default('') }}"

- name: Skip functional test if credentials missing
  ansible.builtin.debug:
    msg: "Skipping functional test for {{ _user }} - credentials not available in agnosticd_user_data"
  when: _librechat_url == '' or _librechat_user == '' or _librechat_password == ''

- name: Authenticate to LibreChat for {{ _user }}
  ansible.builtin.uri:
    url: "{{ _librechat_url }}/api/auth/login"
    method: POST
    body_format: json
    body:
      email: "{{ _librechat_user }}"
      password: "{{ _librechat_password }}"
    validate_certs: "{{ ocp4_workload_mcp_with_openshift_validation_http_validate_certs }}"
    status_code: [200, 201]
  register: _auth_response
  ignore_errors: true
  when: _librechat_url != '' and _librechat_user != '' and _librechat_password != ''

- name: Test OpenShift MCP integration for {{ _user }}
  ansible.builtin.uri:
    url: "{{ _librechat_url }}/api/ask"
    method: POST
    body_format: json
    headers:
      Cookie: "{{ _auth_response.set_cookie }}"
    body:
      text: "List my OpenShift projects using the OpenShift MCP server. Return just the project names."
      conversationId: null
    validate_certs: "{{ ocp4_workload_mcp_with_openshift_validation_http_validate_certs }}"
    status_code: [200]
    timeout: "{{ ocp4_workload_mcp_with_openshift_validation_functional_test_timeout }}"
  register: _openshift_mcp_test
  ignore_errors: true
  when:
    - _librechat_url != ''
    - _auth_response is succeeded

- name: Verify OpenShift MCP responded with project data
  ansible.builtin.set_fact:
    _openshift_mcp_working: >-
      {{
        _openshift_mcp_test is succeeded and
        _openshift_mcp_test.json is defined and
        (_openshift_mcp_test.json.text | default('') | regex_search('agent-' ~ _user ~ '|librechat-' ~ _user ~ '|mcp-|project|namespace'))
      }}
  when: _auth_response is succeeded

- name: Test Gitea MCP integration for {{ _user }}
  ansible.builtin.uri:
    url: "{{ _librechat_url }}/api/ask"
    method: POST
    body_format: json
    headers:
      Cookie: "{{ _auth_response.set_cookie }}"
    body:
      text: "List my Gitea repositories using the Gitea MCP server. Return just the repository names."
      conversationId: null
    validate_certs: "{{ ocp4_workload_mcp_with_openshift_validation_http_validate_certs }}"
    status_code: [200]
    timeout: "{{ ocp4_workload_mcp_with_openshift_validation_functional_test_timeout }}"
  register: _gitea_mcp_test
  ignore_errors: true
  when:
    - _librechat_url != ''
    - _auth_response is succeeded

- name: Verify Gitea MCP responded with repository data
  ansible.builtin.set_fact:
    _gitea_mcp_working: >-
      {{
        _gitea_mcp_test is succeeded and
        _gitea_mcp_test.json is defined and
        (_gitea_mcp_test.json.text | default('') | regex_search('repository|repo|mcp'))
      }}
  when: _auth_response is succeeded

- name: Determine MCP functional test status for {{ _user }}
  ansible.builtin.set_fact:
    _mcp_functional_status: >-
      {{
        'failed' if (_librechat_url == '' or not (_auth_response is succeeded))
        else 'degraded' if (not (_openshift_mcp_working | default(false)) or not (_gitea_mcp_working | default(false)))
        else 'healthy'
      }}

- name: Add MCP functional test validation result for {{ _user }}
  ansible.builtin.set_fact:
    _validation_results: >-
      {{
        _validation_results + [{
          'component': _user + ' MCP Integration Test',
          'namespace': 'functional-test',
          'status': _mcp_functional_status,
          'details': {
            'auth_successful': _auth_response is succeeded if _auth_response is defined else false,
            'openshift_mcp_working': _openshift_mcp_working | default(false),
            'gitea_mcp_working': _gitea_mcp_working | default(false),
            'openshift_mcp_url': _openshift_mcp_url if _openshift_mcp_url != '' else 'N/A',
            'gitea_mcp_url': _gitea_mcp_url if _gitea_mcp_url != '' else 'N/A'
          }
        }]
      }}

- name: Add MCP functional test issue for {{ _user }} if not healthy
  ansible.builtin.set_fact:
    _validation_issues: >-
      {{
        _validation_issues + [_user + ' MCP Integration: ' + (
          'credentials not available' if _librechat_url == ''
          else 'authentication failed' if not (_auth_response is succeeded)
          else 'OpenShift MCP not responding correctly' if not (_openshift_mcp_working | default(false))
          else 'Gitea MCP not responding correctly'
        )]
      }}
  when: _mcp_functional_status != 'healthy'
