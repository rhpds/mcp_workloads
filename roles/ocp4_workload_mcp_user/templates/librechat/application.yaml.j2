---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: librechat-{{ ocp4_workload_mcp_user}}
  namespace: openshift-gitops
  finalizers:
  - argoproj.io/finalizer
spec:
  destination:
    name: ""
    namespace: {{ ocp4_workload_mcp_librechat_namespace }}
    server: https://kubernetes.default.svc
  project: default
  syncPolicy:
    syncOptions:
    - CreateNamespace=false
    automated:
      prune: true
      selfHeal: false
  source:
    repoURL: {{ ocp4_workload_mcp_librechat_repo }}
    path: {{ ocp4_workload_mcp_librechat_repo_path }}
    targetRevision: {{ ocp4_workload_mcp_librechat_repo_tag }}
    helm:
      values: |
        fullnameOverride: librechat

        # OpenShift compatibility - OpenShift assigns UIDs automatically
        # Main LibreChat app - must explicitly set these to empty/false
        podSecurityContext:
          fsGroup: null

        securityContext:
          capabilities:
            drop:
            - ALL
          runAsNonRoot: false
          runAsUser: null

        # Environment variables for LibreChat
        librechat:
          # Custom librechat.yaml configuration
          # https://www.librechat.ai/docs/configuration/librechat_yaml
          configYamlContent: |-
            version: 1.0.8
            cache: true

            # Remote MCP Server Configuration
            mcpServers:
              openshift:
                type: streamable-http
                url: http://mcp-openshift-proxy.{{ ocp4_workload_mcp_namespace }}.svc:8000/mcp
              gitea:
                type: streamable-http
                url: http://mcp-gitea-proxy.{{ ocp4_workload_mcp_namespace }}.svc:8000/mcp

            # Custom OpenAI-compatible endpoints
            # https://www.librechat.ai/docs/configuration/librechat_yaml/object_structure/custom_endpoint
            endpoints:
              custom:
              - name: "LiteMaaS"
                apiKey: "${CUSTOM_API_KEY}"
                baseURL: {{ ocp4_workload_mcp_librechat_litemaas_url }}
                models:
                  default: {{ ocp4_workload_mcp_librechat_litemaas_models }}
                  fetch: true
                titleConvo: false
                summarize: false
                forcePrompt: false
                modelDisplayLabel: "LiteMaaS"
                dropParams:
                - "user"
                - "frequency_penalty"
                - "presence_penalty"

          configEnv:
            ALLOW_REGISTRATION: "true"
            ALLOW_EMAIL_LOGIN: "true"

        # Don't configure ingress, create a route for OpenShift outside of the helm chart
        ingress:
          enabled: false
          # hosts:
          #   - host: librechat-user1.apps.cluster-qw87b.dynamic.redhatworkshops.io
          #     paths:
          #       - path: /
          #         pathType: ImplementationSpecific

        # Add writable volumes for logs (multiple locations)
        volumes:
        - name: logs
          emptyDir: {}
        - name: logs-root
          emptyDir: {}

        volumeMounts:
        - name: logs
          mountPath: /app/api/logs
        - name: logs-root
          mountPath: /app/logs

        # Global OpenShift compatibility for MongoDB
        global:
          compatibility:
            openshift:
              adaptSecurityContext: force

        # MongoDB configuration
        # IMPORTANT: As of August 2025, Bitnami only provides "latest" tag in free tier
        # Current version running: MongoDB 8.2.2
        # Options for pinning versions:
        #   1. Use image digest (recommended): docker.io/bitnami/mongodb@sha256:xxxxx
        #   2. Use Bitnami Legacy repo: docker.io/bitnamilegacy/mongodb:8.0-debian-12
        #   3. Use official MongoDB image: docker.io/mongo:8.2.2 (requires different config)
        mongodb:
          image:
            tag: "latest"
            # To pin to current version (MongoDB 8.2.2), uncomment the line below and comment out tag:
            # digest: "sha256:219bea2e10ac98619a0a2edbce0c5119635ffd2518852cd75c77da234e610327"
          global:
            compatibility:
              openshift:
                adaptSecurityContext: force

        # Meilisearch configuration - override all security contexts
        meilisearch:
          podSecurityContext:
            runAsNonRoot: false
            runAsUser: null
            runAsGroup: null
            fsGroup: null
            fsGroupChangePolicy: null
          securityContext: {}
